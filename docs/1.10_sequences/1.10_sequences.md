# 1.10 - Sequences LMS

## 0. Liste Features

### Existantes (POC)

| Feature | Status |
|---------|--------|
| Video tracking | ✅ |
| Quiz (Tally) | ✅ |
| Course loading | ✅ |
| Leaderboard | ✅ |
| Auth (CF Access) | ✅ |

### Cibles (1.01)

| Feature | Status |
|---------|--------|
| User dashboard | ❌ |
| Admin dashboard | ❌ |
| Mastery % | ❌ |
| Streaks | ❌ |
| Hearts/lives | ❌ |

---

## 1. Sequences EXISTANTES

### Video Tracking

```mermaid
sequenceDiagram
    participant U as User
    participant P as Player
    participant VT as video/tracking.js
    participant API as /api/events
    participant HE as handlers/events.js
    participant PE as projections/engine.js
    participant DB as D1

    U->>P: Watch video
    P->>VT: timeupdate (10s interval)
    VT->>API: POST {VIDEO_PING, position, duration}
    API->>HE: handleEvent()
    HE->>DB: INSERT lms_event
    HE->>PE: applyProjections()
    PE->>DB: UPSERT v_user_progress
    PE->>DB: INSERT lms_signal (if completed)
    PE-->>HE: {video_completed}
    HE-->>VT: {success, video_completed}
    VT->>P: Update UI (if completed)
```

**Points debug**: VT→API (payload), HE→DB (event stored), PE→DB (projection applied)

### Quiz Submission (Tally)

```mermaid
sequenceDiagram
    participant T as Tally
    participant WH as /api/tally-webhook
    participant HQ as handlers/quiz.js
    participant PE as projections/engine.js
    participant DB as D1

    T->>WH: POST (webhook payload)
    WH->>HQ: handleTallyWebhook()
    HQ->>DB: INSERT lms_event (QUIZ_SUBMIT)
    HQ->>PE: applyProjections()
    PE->>DB: UPSERT v_user_progress
    PE->>DB: INSERT lms_signal (QUIZ_PASSED)
    PE-->>HQ: {quiz_passed, score}
    HQ-->>T: 200 OK
```

**Points debug**: WH (signature verify), HQ→DB (event), PE (projection result)

### Course Loading

```mermaid
sequenceDiagram
    participant U as User
    participant IDX as index.js
    participant CL as course/loader.js
    participant HC as handlers/courses.js
    participant HS as handlers/signals.js
    participant DB as D1
    participant CR as course/renderer.js

    U->>IDX: Navigate /?som=X
    IDX->>CL: loadCourse(X)
    CL->>HC: GET /courses/X
    HC->>DB: SELECT lms_course, lms_class
    HC-->>CL: {course, classes}
    CL->>HS: GET /signals/X
    HS->>DB: SELECT lms_signal, v_user_progress
    HS-->>CL: {signals, can_access_step}
    CL->>CR: render(course, signals)
    CR-->>U: Display step
```

**Points debug**: CL→HC (course data), CL→HS (signals), CR (render)

### Auth Flow

```mermaid
sequenceDiagram
    participant U as User
    participant CF as CF Access
    participant IDX as index.js
    participant AUTH as auth.js
    participant DB as D1

    U->>CF: Access app
    CF->>CF: Verify identity
    CF->>IDX: Redirect + JWT cookie
    IDX->>AUTH: authenticateRequest()
    AUTH->>AUTH: verifyAccessJWT()
    AUTH->>DB: getOrCreateContact()
    AUTH-->>IDX: {user, student}
```

**Points debug**: AUTH (JWT verify), DB (student created/found)

---

## 2. Sequences CIBLES

### User Dashboard

```mermaid
sequenceDiagram
    participant U as User
    participant UD as user_dashboard.js
    participant FD as front_dashboard.js
    participant DB as D1

    U->>UD: Navigate /dashboard
    UD->>FD: GET /api/front_dashboard
    FD->>DB: SELECT v_course_progress
    FD->>DB: SELECT v_skill_mastery
    FD->>DB: SELECT v_streak_history
    FD-->>UD: {courses, mastery, streak}
    UD-->>U: Render dashboard
```

**Status**: ❌ Non implémenté (GAP-801, GAP-601→603)

### Admin Dashboard

```mermaid
sequenceDiagram
    participant A as Admin
    participant AD as admin_dashboard.js
    participant FA as front_admin.js
    participant DB as D1

    A->>AD: Navigate /admin
    AD->>FA: GET /api/front_admin
    FA->>DB: SELECT v_admin_overview
    FA->>DB: SELECT v_user_activity
    FA-->>AD: {students, stats}
    AD-->>A: Render admin view
```

**Status**: ❌ Non implémenté (GAP-802, GAP-604)

### Streak Calculation (Cron)

```mermaid
sequenceDiagram
    participant CRON as Cron Trigger
    participant JOB as jobs/streak.js
    participant DB as D1

    CRON->>JOB: Trigger (daily)
    JOB->>DB: SELECT last activity per user
    JOB->>DB: UPDATE streak_count (increment or reset)
    JOB->>DB: INSERT lms_signal (STREAK_UPDATED)
    JOB-->>CRON: {processed}
```

**Status**: ❌ Non implémenté (GAP-803)

### Hearts/Lives

```mermaid
sequenceDiagram
    participant U as User
    participant QH as quiz/handler.js
    participant PE as projections/engine.js
    participant HRT as hearts handler
    participant DB as D1

    U->>QH: Submit quiz (fail)
    QH->>PE: applyProjections()
    PE->>HRT: decrementHeart()
    HRT->>DB: UPDATE hearts SET count = count - 1
    HRT-->>PE: {hearts_remaining}
    PE-->>QH: {quiz_failed, hearts: N}
    QH-->>U: Display "X hearts left"
```

**Status**: ❌ Non implémenté (GAP-804, GAP-806)

---

## 3. Analyse Non-linéarités

| Sequence | Non-linéarité | Status |
|----------|---------------|--------|
| Video tracking | Loop 10s → single event | ✅ OK |
| Quiz Tally | Webhook async | ✅ OK (fire & forget) |
| Course loading | 2 API calls séquentiels | ⚠️ Pourrait être 1 seul |
| Projections | Chain sync | ✅ OK |

**GAP potentiel**: Course loading fait 2 calls (courses + signals). Pourrait être fusionné.

---

## 4. GAPs

| ID | Feature | Séquence manquante | Sévérité |
|----|---------|-------------------|----------|
| GAP-1001 | User dashboard | Flux complet front→back→views | P1 |
| GAP-1002 | Admin dashboard | Flux complet front→back→views | P1 |
| GAP-1003 | Streak cron | Job daily + signal | P2 |
| GAP-1004 | Hearts decrement | Projection + update | P2 |
| GAP-1005 | Course loading | Fusion 2 calls en 1 | P3 |

---

*Créé le : 2024-12-28*

