# 1.08 - Flux Architecture LMS

## 1. Flux EXISTANT

```mermaid
flowchart TB
    subgraph Browser
        IDX[index.js]
        VT[video/tracking.js]
        CL[course/loader.js]
        LB[leaderboard.js]
    end

    subgraph Workers
        RTR[Router]
        HE[events.js]
        HC[courses.js]
        HS[signals.js]
        HL[leaderboard.js]
        PE[projections/engine.js]
    end

    subgraph D1
        EVT[(lms_event)]
        SIG[(lms_signal)]
        PRG[(v_user_progress)]
        CRS[(lms_course)]
    end

    subgraph External
        CF[CF Access]
        TALLY[Tally]
        STREAM[CF Stream]
    end

    CF --> RTR
    VT -->|VIDEO_PING| HE --> EVT
    HE --> PE --> PRG
    PE --> SIG
    TALLY -->|QUIZ_SUBMIT| HE
    CL --> HC --> CRS
    CL --> HS --> SIG
    LB --> HL --> SIG
    STREAM --> VT
```

**Couverture existante :**
- ✅ Video tracking (ping → event → projection)
- ✅ Quiz via Tally webhook
- ✅ Course loading + progress
- ✅ Leaderboard basique
- ✅ Auth Cloudflare Access

---

## 2. Flux CIBLE (basé sur 1.01)

```mermaid
flowchart TB
    subgraph Browser
        IDX[index.js]
        VT[video/tracking.js]
        CL[course/loader.js]
        LB[leaderboard.js]
        UD[user_dashboard.js]
        AD[admin_dashboard.js]
        HRT[hearts.js]
        STK[streak.js]
        MST[mastery.js]
    end

    subgraph Workers
        RTR[Router]
        HE[events.js]
        HC[courses.js]
        HS[signals.js]
        HL[leaderboard.js]
        PE[projections/engine.js]
        FD[front_dashboard.js]
        FA[front_admin.js]
        FM[front_mastery.js]
        JOB[jobs/streak.js]
        HRTJ[jobs/hearts.js]
    end

    subgraph D1
        STU[(lms_student)]
        INS[(lms_instructor)]
        EVT[(lms_event)]
        SIG[(lms_signal)]
        PRG[(v_user_progress)]
        CRS[(lms_course)]
        VCP[(v_course_progress)]
        VCM[(v_course_mastery)]
        VSM[(v_skill_mastery)]
        VAO[(v_admin_overview)]
        VSH[(v_streak_history)]
        HRT_TBL[(hearts)]
    end

    subgraph External
        CF[CF Access]
        TALLY[Tally]
        STREAM[CF Stream]
        CRON[Cron Trigger]
    end

    %% Existant
    CF --> RTR
    VT --> HE --> EVT
    HE --> PE --> PRG
    PE --> SIG
    TALLY --> HE
    CL --> HC --> CRS
    CL --> HS --> SIG
    LB --> HL --> SIG

    %% CIBLE: Dashboards
    UD --> FD --> VCP
    FD --> VCM
    FD --> VSM
    AD --> FA --> VAO

    %% CIBLE: Mastery
    MST --> FM --> VCM
    FM --> VSM

    %% CIBLE: Streaks
    CRON --> JOB --> VSH
    STK --> HS --> VSH

    %% CIBLE: Hearts
    HRT --> HRTJ --> HRT_TBL
    PE -->|quiz fail| HRTJ
```

---

## 3. Analyse GAP (Existant vs Cible)

| Composant | Existant | Cible | GAP |
|-----------|----------|-------|-----|
| **Front** |
| user_dashboard.js | ❌ | ✅ | GAP-801 |
| admin_dashboard.js | ❌ | ✅ | GAP-802 |
| hearts.js | ❌ | ✅ | GAP-804 |
| streak.js | ❌ | ✅ | GAP-803 |
| mastery.js | ❌ | ✅ | GAP-805 |
| **Back** |
| front_dashboard.js | ❌ | ✅ | GAP-801 |
| front_admin.js | ❌ | ✅ | GAP-802 |
| front_mastery.js | ❌ | ✅ | GAP-805 |
| jobs/streak.js | ❌ | ✅ | GAP-803 |
| jobs/hearts.js | ❌ | ✅ | GAP-804 |
| **DB** |
| v_course_progress | ❌ | ✅ | GAP-601 |
| v_course_mastery | ❌ | ✅ | GAP-602 |
| v_skill_mastery | ❌ | ✅ | GAP-603 |
| v_admin_overview | ❌ | ✅ | GAP-604 |
| v_streak_history | ❌ | ✅ | GAP-605 |
| hearts table | ❌ | ✅ | GAP-806 |

---

## 4. GAPs Nouveaux (1.08)

| ID | Description | Sévérité |
|----|-------------|----------|
| GAP-805 | Flux mastery (front + back) | P1 |
| GAP-806 | Table hearts manquante | P2 |

*Note: GAP-801→804 déjà identifiés, GAP-601→605 viennent de 1.06*

---

*Créé le : 2024-12-28*
