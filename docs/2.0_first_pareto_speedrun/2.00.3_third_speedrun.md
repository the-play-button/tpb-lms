# Third Pareto Speedrun - LMS

**Objectif** : 8 GAPs en ~4h - Fondations pour dashboards + UX visible---

## Selection Pareto - Impact x Faisabilite

| Tier | GAP | Feature | Temps | Impact ||------|-----|---------|-------|--------|| 1 | GAP-1208 | resolveRole() | 20 min | Pre-requis RBAC || 1 | GAP-1201 | Roles dans userContext | 15 min | Securite || 2 | GAP-604 | v_admin_overview | 20 min | Stats admin || 2 | GAP-602 | v_course_mastery | 15 min | Mastery % enrichi || 3 | GAP-101 | Playback speed UI | 45 min | UX critique || 3 | GAP-112 | Mastery badges UI | 45 min | Gamification visible || 4 | GAP-1502 | OpenAPI basique | 30 min | Documentation || 4 | GAP-1504 | Dossier middleware/ | 10 min | Organisation code |**Total estime** : ~3h30---

## Tier 1 : RBAC Light (~35 min)

### GAP-1208 : resolveRole()

Ajouter fonction dans [`backend/auth.js`](tpb_system/04.Execution/lms/backend/auth.js) :

```javascript
// Resolve role from email (IAMPAM pattern)
// Check order: hris_employee (instructor/admin) -> crm_contact (student)
export async function resolveRole(email, env) {
  // Check if employee (internal = instructor or admin)
  const employee = await env.DB.prepare(`
    SELECT id, employee_roles_json FROM hris_employee 
    WHERE json_extract(emails_json, '$[0].email') = ?
  `).bind(email).first();
  
  if (employee) {
    const roles = JSON.parse(employee.employee_roles_json || '[]');
    if (roles.includes('admin')) return 'admin';
    return 'instructor';
  }
  
  // Default: student (external user)
  return 'student';
}
```



### GAP-1201 : Roles dans userContext

Modifier `authenticateRequest()` dans [`backend/auth.js`](tpb_system/04.Execution/lms/backend/auth.js) pour inclure le role :

```javascript
// Apres JWT verification reussie:
const role = await resolveRole(jwtResult.email, env);
return { 
  user: { email: jwtResult.email, role, payload: jwtResult.payload },
  contact,
  learner: contact,
  authMethod: 'jwt'
};
```

---

## Tier 2 : Vues SQL Admin (~35 min)

### GAP-604 : v_admin_overview

Ajouter dans [`db/schema.sql`](tpb_system/04.Execution/lms/db/schema.sql) :

```sql
-- Vue admin overview (stats globales)
CREATE VIEW IF NOT EXISTS v_admin_overview AS
SELECT 
  (SELECT COUNT(DISTINCT user_id) FROM lms_event) as total_students,
  (SELECT COUNT(DISTINCT user_id) FROM lms_event 
   WHERE occurred_at > datetime('now', '-24 hours')) as active_24h,
  (SELECT COUNT(DISTINCT user_id) FROM lms_event 
   WHERE occurred_at > datetime('now', '-7 days')) as active_7d,
  (SELECT COUNT(*) FROM lms_signal WHERE type = 'COURSE_COMPLETED') as courses_completed,
  (SELECT COUNT(*) FROM lms_signal WHERE type = 'VIDEO_COMPLETED') as videos_completed,
  (SELECT COUNT(*) FROM lms_signal WHERE type = 'QUIZ_PASSED') as quizzes_passed,
  (SELECT AVG(json_extract(data_json, '$.score')) FROM lms_signal 
   WHERE type = 'QUIZ_PASSED') as avg_quiz_score;
```

Ajouter endpoint GET `/api/admin/stats` dans [`backend/index.js`](tpb_system/04.Execution/lms/backend/index.js) avec guard role=admin.

### GAP-602 : v_course_mastery

Enrichir la vue existante pour inclure mastery level :

```sql
-- Mastery levels: bronze (25%), silver (50%), gold (75%), master (100%)
CREATE VIEW IF NOT EXISTS v_course_mastery AS
SELECT 
  p.*,
  CASE 
    WHEN p.progress_percent >= 100 THEN 'master'
    WHEN p.progress_percent >= 75 THEN 'gold'
    WHEN p.progress_percent >= 50 THEN 'silver'
    WHEN p.progress_percent >= 25 THEN 'bronze'
    ELSE 'none'
  END as mastery_level
FROM v_course_progress p;
```

Enrichir signals avec mastery_level.---

## Tier 3 : Frontend Features (~1h30)

### GAP-101 : Playback Speed UI

Cloudflare Stream supporte `playbackRate`. Modifier [`frontend/app/video/tracking.js`](tpb_system/04.Execution/lms/frontend/app/video/tracking.js) :

```javascript
// Speed control (0.5x, 1x, 1.5x, 2x)
const SPEEDS = [0.5, 1, 1.5, 2];
let currentSpeedIndex = 1;

export function cyclePlaybackSpeed() {
  if (!streamPlayer) return;
  currentSpeedIndex = (currentSpeedIndex + 1) % SPEEDS.length;
  streamPlayer.playbackRate = SPEEDS[currentSpeedIndex];
  showToast(`Vitesse: ${SPEEDS[currentSpeedIndex]}x`);
}

export function getCurrentSpeed() {
  return SPEEDS[currentSpeedIndex];
}
```

Ajouter bouton speed dans [`frontend/app/course/renderer.js`](tpb_system/04.Execution/lms/frontend/app/course/renderer.js) :

```html
<button class="speed-btn" onclick="window.cycleSpeed()" title="Changer vitesse">
  <span id="speed-display">1x</span>
</button>
```

CSS dans `frontend/styles/course.css` pour le bouton.

### GAP-112 : Mastery Badges UI

Creer [`frontend/app/ui/masteryBadge.js`](tpb_system/04.Execution/lms/frontend/app/ui/masteryBadge.js) :

```javascript
// Mastery badge component
const BADGES = {
  none:   { icon: 'âšª', label: 'Non commence', color: '#666' },
  bronze: { icon: 'ðŸ¥‰', label: 'Bronze (25%)', color: '#cd7f32' },
  silver: { icon: 'ðŸ¥ˆ', label: 'Silver (50%)', color: '#c0c0c0' },
  gold:   { icon: 'ðŸ¥‡', label: 'Gold (75%)', color: '#ffd700' },
  master: { icon: 'ðŸ‘‘', label: 'Master (100%)', color: '#9b59b6' }
};

export function renderMasteryBadge(level) {
  const badge = BADGES[level] || BADGES.none;
  return `<span class="mastery-badge" style="color:${badge.color}" title="${badge.label}">${badge.icon}</span>`;
}
```

Integrer dans course list et step header.---

## Tier 4 : DevOps (~40 min)

### GAP-1504 : Organisation middleware/

Le dossier `backend/middleware/` existe deja avec :

- `trace.js`
- `rateLimit.js`
- `idempotency.js`

Creer [`backend/middleware/guard.js`](tpb_system/04.Execution/lms/backend/middleware/guard.js) :

```javascript
// Role guard middleware (Intent + Guard pattern)
export function requireRole(...allowedRoles) {
  return (userContext) => {
    const role = userContext?.user?.role || 'student';
    if (!allowedRoles.includes(role)) {
      return { error: 'Forbidden', requiredRole: allowedRoles };
    }
    return null; // OK
  };
}
```



### GAP-1502 : OpenAPI basique

Creer [`docs/openapi.yaml`](tpb_system/04.Execution/lms/docs/openapi.yaml) documentant :

- `/api/health` (public)
- `/api/courses` (auth)
- `/api/signals/{courseId}` (auth)
- `/api/events` (auth)
- `/api/quiz` (auth)
- `/api/admin/stats` (admin)

---

## Ordre d'execution

```javascript
1. GAP-1504 (10 min) â†’ Organisation middleware/
2. GAP-1208 (20 min) â†’ resolveRole()
3. GAP-1201 (15 min) â†’ Roles dans userContext
4. GAP-604  (20 min) â†’ v_admin_overview + endpoint
5. GAP-602  (15 min) â†’ v_course_mastery enrichi
6. GAP-112  (45 min) â†’ Mastery badges UI
7. GAP-101  (45 min) â†’ Playback speed
8. GAP-1502 (30 min) â†’ OpenAPI doc
```

**Raison** : Fondations (RBAC) d'abord, puis data (vues SQL), puis UI visible.---

## Metriques de succes

| Metrique | Avant | Apres ||----------|-------|-------|| RBAC | Aucun | 3 roles (student/instructor/admin) || Admin stats | 0 | v_admin_overview + endpoint || Mastery visible | Non | Badges bronze/silver/gold/master || Playback speed | Non | 0.5x/1x/1.5x/2x || API documentee | Non | OpenAPI basique |---

## Fichiers impactes

| Fichier | Modifications ||---------|---------------|| `backend/auth.js` | +resolveRole(), +role dans userContext || `backend/index.js` | +endpoint /api/admin/stats || `backend/middleware/guard.js` | Nouveau fichier || `db/schema.sql` | +v_admin_overview, +v_course_mastery || `backend/handlers/signals.js` | +mastery_level dans response || `frontend/app/video/tracking.js` | +playback speed functions || `frontend/app/course/renderer.js` | +speed button UI || `frontend/app/ui/masteryBadge.js` | Nouveau fichier || `frontend/styles/course.css` | +styles speed button, mastery badge || `docs/openapi.yaml` | Nouveau fichier |---

## Dependances

| GAP | Dependance ||-----|------------|| GAP-1201 | GAP-1208 (resolveRole) || GAP-604 endpoint | GAP-1201 (role guard) || GAP-112 UI | GAP-602 (mastery_level) |---

## Hors scope (trop complexe)