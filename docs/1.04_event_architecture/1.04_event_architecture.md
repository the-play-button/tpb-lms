# 1.04 - Event Architecture LMS

## Events (lms_event)

| Type | Trigger | Payload |
|------|---------|---------|
| VIDEO_PING | Toutes 10s pendant lecture | `{video_id, position, duration}` |
| QUIZ_SUBMIT | Soumission quiz Tally | `{quiz_id, score, max_score, passed}` |

## Signals (lms_signal)

| Type | Dérivé de | Condition |
|------|-----------|-----------|
| VIDEO_COMPLETED | VIDEO_PING | position >= 90% duration |
| QUIZ_PASSED | QUIZ_SUBMIT | passed = true |
| STEP_COMPLETED | VIDEO + QUIZ | vidéo OK + quiz OK (si quiz) |
| COURSE_COMPLETED | STEP_COMPLETED | tous steps OK |

## Vue matérialisée (v_user_progress)

| Colonne | Type | Source |
|---------|------|--------|
| user_id | TEXT | PK |
| class_id | TEXT | PK |
| course_id | TEXT | FK |
| video_max_position_sec | INT | VIDEO_PING |
| video_completed | INT (0/1) | Projection |
| quiz_passed | INT (0/1) | Projection |
| quiz_score | INT | QUIZ_SUBMIT |

## Projections

| Fichier | Event | Logique |
|---------|-------|---------|
| `projections/rules/video_progress.js` | VIDEO_PING | max(position), completed si >=90% |
| `projections/rules/quiz_result.js` | QUIZ_SUBMIT | passed, score |

## Vues monitoring

| Vue | Usage |
|-----|-------|
| v_event_daily_stats | Events par jour/type |
| v_signal_summary | Comptage signals par user |
| v_leaderboard | Ranking XP |
| v_user_activity | Last activity, events 24h |

## GAPs

| ID | Description | Sévérité |
|----|-------------|----------|
| GAP-401 | SDK TPB Events non utilisé - implémentation custom | P2 |
| GAP-402 | Eventual Consistency - Pas de stratégie de retry/réconciliation si projection échoue | P3 |
| GAP-403 | Event Versioning - Pas de stratégie de versioning des events | P3 |
| GAP-404 | Event Replay - Pas de capacité de replay documentée | P3 |
| GAP-405 | Domain vs Integration Events - Pas de distinction formelle | P3 |

L'architecture fonctionne mais n'utilise pas le SDK `tpb_events/`. Refacto à prévoir.

**Nouveaux GAPs identifiés (Phase 3)** :
- Eventual Consistency : actuellement si une projection échoue, l'event est perdu. À prévoir : queue de retry ou mécanisme de réconciliation.
- Event Versioning : les events n'ont pas de version. En cas de changement de schéma, migration à gérer manuellement.
- Event Replay : le replay est théoriquement possible (events immutables) mais pas testé/documenté.
- Domain vs Integration : tous les events sont traités de la même manière, sans distinction contrat/interne.

