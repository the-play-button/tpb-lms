# 1.07 - Endpoints LMS

## 1. Endpoints Existants

### Public (no auth)

| Endpoint | Method | Input | Output | Side-effects |
|----------|--------|-------|--------|--------------|
| `/api/health` | GET | - | `{status, timestamp, version}` | Aucun |
| `/api/tally-webhook` | POST | Tally payload | `{success}` | INSERT lms_event, projections |

### Protected (JWT Cloudflare Access)

| Endpoint | Method | Input | Output | Side-effects |
|----------|--------|-------|--------|--------------|
| `/api/auth/session` | GET | - | `{user, student}` | Aucun |
| `/api/events` | POST | `{type, course_id, class_id, payload}` | `{event_id}` | INSERT lms_event, projections |
| `/api/events/batch` | POST | `[{type, ...}]` | `{processed}` | INSERT lms_event (batch), projections |
| `/api/signals/:courseId` | GET | - | `{signals, can_access_step}` | Aucun |
| `/api/signals/:courseId/:classId` | GET | - | `{video_completed, quiz_passed}` | Aucun |
| `/api/signals/:courseId/reset` | POST | - | `{deleted}` | DELETE lms_signal, v_user_progress |
| `/api/courses` | GET | `?active=true` | `[{id, name, classes}]` | Aucun |
| `/api/courses/:id` | GET | - | `{course, classes, progress}` | Aucun |
| `/api/badges` | GET | - | `[{id, name, earned}]` | Aucun |
| `/api/student` | GET | - | `{student, xp, badges, progress}` | Aucun |
| `/api/stats` | GET | - | `{total_xp, badges, rank}` | Aucun |
| `/api/leaderboard` | GET | `?limit=10` | `[{student_id, points, rank}]` | Aucun |

### Legacy (backward compat)

| Endpoint | Method | Redirect |
|----------|--------|----------|
| `/api/soms` | GET | → `/api/courses` |
| `/api/soms/:id` | GET | → `/api/courses/:id` |
| `/api/video-event` | POST | → `/api/events` (transformed) |
| `/api/quiz-submission` | POST | → handleQuizSubmission |
| `/api/progress/:id` | GET | → `/api/signals/:id` |
| `/api/progress/:id/reset` | POST | → `/api/signals/:id/reset` |
| `/api/learner` | GET | → `/api/student` |

## 2. Endpoints CIBLES (CRUD unified.to)

### Manquants CRUD

| Resource | GET list | GET one | POST | PUT | DELETE |
|----------|----------|---------|------|-----|--------|
| courses | ✅ | ✅ | ❌ | ❌ | ❌ |
| classes | ❌ | ❌ | ❌ | ❌ | ❌ |
| badges | ✅ | ❌ | ❌ | ❌ | ❌ |
| students | ❌ | ❌ | ❌ | ❌ | ❌ |
| instructors | ❌ | ❌ | ❌ | ❌ | ❌ |

### Manquants front_

| Endpoint | Usage | Source GAP |
|----------|-------|------------|
| `/api/front_dashboard` | Données user dashboard | GAP-104 |
| `/api/front_admin` | Données admin dashboard | GAP-106 |
| `/api/front_mastery/:courseId` | Mastery % du cours | GAP-108 |

### Manquants jobs/cron

| Endpoint | Usage |
|----------|-------|
| `/api/jobs/streak_check` | Calcul streaks quotidien |
| `/api/jobs/cleanup` | Nettoyage orphelins |

## 3. Endpoints à Protéger (→ 1.12)

| Endpoint | Niveau | Notes |
|----------|--------|-------|
| `/api/events` | student | Write propre student seulement |
| `/api/signals/*/reset` | student | Reset propre student seulement |
| `/api/front_admin` | admin | Admin only |
| `/api/courses` POST/PUT/DELETE | instructor/admin | CRUD instructors + admin |
| `/api/badges` POST/PUT/DELETE | admin | CRUD admin only |
| `/api/students` | admin | CRUD admin only |
| `/api/instructors` | admin | CRUD admin only |
| `/api/jobs/*` | system | Cron only (secret) |

## 4. GAPs

| ID | Endpoint | Feature | Sévérité |
|----|----------|---------|----------|
| GAP-701 | CRUD courses complet | API Ready | P2 |
| GAP-702 | CRUD classes | API Ready | P2 |
| GAP-703 | CRUD badges | API Ready | P2 |
| GAP-704 | CRUD students | API Ready | P2 |
| GAP-704b | CRUD instructors | API Ready | P2 |
| GAP-705 | front_dashboard | User dashboard | P1 |
| GAP-706 | front_admin | Admin dashboard | P1 |
| GAP-707 | front_mastery | Mastery % | P1 |
| GAP-708 | jobs/streak_check | Streaks | P2 |
| GAP-709 | jobs/cleanup | Entropy | P3 |
| GAP-710 | Input Validation | Pas de schéma Zod/JSON Schema sur les endpoints | P2 |
| GAP-711 | Idempotency | POST /events non idempotent (double submit possible) | P2 |

**Nouveaux GAPs identifiés** :
- Input Validation : les endpoints acceptent les payloads sans validation formelle. À ajouter : schémas Zod pour chaque endpoint.
- Idempotency : les endpoints POST peuvent être appelés en double (retry) sans protection. À ajouter : header X-Idempotency-Key.

---

*Mis à jour le : 2024-12-28*
