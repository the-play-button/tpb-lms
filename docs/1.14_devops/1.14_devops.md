# 1.14 - Audit DevOps

> Audit de l'infrastructure DevOps du POC LMS : scripts de déploiement, rollback, environnements, sécurité, scaling et CI/CD.

---

## CONSTAT PRINCIPAL : Fragmentation organisationnelle

```
02.Directives/
├── lms/                    ← 10 fichiers directives LMS
│   └── deploy_lms.md       ← appelle des scripts dans cloudflare/ !
├── cloudflare/             ← 3 fichiers génériques (mais utilisés par LMS)
│   └── deploy_workers.md   ← utilisé par LMS mais pas dans lms/
└── app_factory/            ← framework d'audit (séparé)

03.Orchestration/
├── lms/courses/            ← configs JSON cours
└── cloudflare/             ← rapports audit (mélange domaines)

04.Execution/
├── lms/                    ← POC complet
│   ├── reset_db.py         ← script à la RACINE (pas scripts/)
│   ├── manage_access.py    ← idem
│   ├── deploy.sh           ← idem
│   ├── worker_api/         ← backend OK
│   ├── frontend/           ← frontend OK
│   └── docs/               ← DOCS D'AUDIT dans Execution (?!)
└── cloudflare/             ← scripts génériques CF
    └── deploy_workers.py   ← utilisé par LMS mais ailleurs
```

**Problèmes identifiés :**

1. **Directives éclatées** : `lms/` dépend de `cloudflare/` sans lien explicite
2. **Scripts éparpillés** : deploy LMS utilise `04.Execution/cloudflare/deploy_workers.py`
3. **Docs mal placées** : audit Phase 1 dans `04.Execution/` au lieu de `docs/`
4. **Pas de scripts/ dans le POC** : tout mélangé à la racine

---

## 1. Scripts de déploiement

### EXISTANT

| Question | Réponse |
|----------|---------|
| Script deploy existe ? | ✅ `deploy.sh` + `reset_db.py --dev` |
| Emplacement ? | Racine du projet (pas dans scripts/devops/) |
| Unifié (un seul point d'entrée) ? | ✅ `reset_db.py --dev` fait tout |
| Gère staging + production ? | ⚠️ Partiel (wrangler.toml a env.staging mais incomplet) |
| Applique migrations DB ? | ✅ Via `schema.sql` |
| Lance smoke tests ? | ❌ Non |

**Directives existantes :**
- `02.Directives/lms/deploy_lms.md` - UNE commande en dev: `reset_db.py --dev`
- `02.Directives/cloudflare/deploy_workers.md` - Deploy frontend Workers
- `02.Directives/cloudflare/audit_devops.md` - Script audit_cloudflare.py

**Scripts existants :**
- `04.Execution/lms/reset_db.py` - Reset DB + deploy tout (--dev flag)
- `04.Execution/lms/deploy.sh` - Script shell interactif (legacy)
- `04.Execution/cloudflare/deploy_workers.py` - Deploy Workers (utilisé par LMS)
- `04.Execution/cloudflare/deploy_pages.py` - Deploy Pages
- `04.Execution/cloudflare/audit_cloudflare.py` - Audit ressources CF

### CIBLE

```
scripts/devops/
├── deploy.py           # Deploy unifié (wrapper reset_db.py)
├── verify_deploy.py    # Smoke tests post-deploy
├── rollback.py         # Rollback rapide
├── check_secrets.py    # Vérifier secrets configurés
└── check_security.py   # Audit sécurité basique
```

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1401 | Scripts à la racine | `scripts/devops/` | P1 |
| GAP-1402 | Pas de verify_deploy | Script smoke tests post-deploy | P2 |
| GAP-1403 | Pas de check_secrets | Script vérification secrets | P2 |
| GAP-1404 | Pas de check_security | Script audit sécurité basique | P2 |
| GAP-1407 | deploy.sh interactif (read -p) | Non-interactif pour CI/CD | P3 |

---

## 2. Rollback

### EXISTANT

| Question | Réponse |
|----------|---------|
| Rollback possible en < 5 min ? | ✅ `wrangler rollback` |
| Procédure documentée ? | ✅ Dans deploy_lms.md |
| Versions précédentes conservées ? | ✅ Wrangler gère ça |
| Migrations DB réversibles ? | ❌ Non (schema additif only) |

**Procédure documentée dans deploy_lms.md :**
```bash
# Worker API
npx wrangler deployments list
npx wrangler rollback

# Frontend - redéployer version précédente via git
git checkout HEAD~1 -- 04.Execution/lms/frontend/
python3 04.Execution/cloudflare/deploy_pages.py deploy ...
```

### CIBLE

- Script `rollback.py --env production --to-version v1.2.3`
- Rollback < 5 min
- N versions précédentes conservées
- Migrations DB réversibles (down migrations)

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| - | Rollback manuel OK | Script unifié (nice-to-have) | P3 |

**Note** : Le rollback existant est acceptable pour un POC. Pas de GAP critique.

---

## 3. Environnements

### EXISTANT

| Aspect | Valeur |
|--------|--------|
| Environnements | staging (incomplet), production |
| Branches git | master (projet dans submodule) |
| Variables d'env séparées | ⚠️ Partiel (prod OK, staging pas de database_id) |

```toml
# wrangler.toml actuel
[env.production]
name = "lms-api"
[[env.production.d1_databases]]
binding = "DB"
database_name = "lms-db"
database_id = "ef408d5f-f191-4743-98b5-cb73429c8283"

[env.staging]
name = "lms-api-staging"
# MANQUE: d1_databases, vars
```

**Git status :**
```
Sur la branche master
Modifications qui ne seront pas validées :
  modifié : tpb_system (nouveaux commits, contenu modifié, contenu non suivi)
```
→ Projet bien versionné, tpb_system est un submodule.

### CIBLE

| Aspect | Valeur |
|--------|--------|
| Environnements | staging, production |
| Branches git | main → prod, develop → staging |
| Variables d'env séparées | ✅ |

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1405 | env.staging incomplet | Staging fonctionnel avec DB séparée | P2 |

---

## 4. Sécurité

### EXISTANT

| Check | Status |
|-------|--------|
| Secrets en variables d'environnement | ✅ wrangler secret put |
| Pas de secrets dans le code source | ✅ |
| Secrets différents staging/prod | ⚠️ Staging incomplet |
| CORS configuré correctement | ✅ Liste blanche dans `cors.js` |
| Headers de sécurité présents | ❌ Pas de CSP, HSTS, X-Frame-Options |
| Access protection obligatoire | ✅ Bien documenté |

**Secrets configurés :**
```bash
# Via wrangler secret put
TALLY_WEBHOOK_SECRET
TALLY_SIGNING_SECRET
CLOUDFLARE_STREAM_SIGNING_KEY_ID
CLOUDFLARE_STREAM_SIGNING_KEY_PEM
```

**CORS (cors.js) :**
```javascript
export const ALLOWED_ORIGINS = [
    'https://lms-viewer.matthieu-marielouise.workers.dev',
    'http://localhost:8080',
    'http://127.0.0.1:8080'
];
```

**Auth (auth.js) :**
- JWT Cloudflare Access vérifié (RS256)
- JWKS cache 1h
- Vérification expiration + audience

### CIBLE

- Tous les checks ✅
- Script `check_secrets.py` bloque le deploy si secret manquant
- Script `check_security.py` audit basique
- Headers sécurité : CSP, HSTS, X-Frame-Options

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1406 | Pas de headers sécurité | CSP, HSTS, X-Frame-Options | P2 |
| GAP-1415 | Pas de rate limiting | Rate limit par IP + par user, réponse 429 + Retry-After | P2 |

**Nouveau GAP identifié** :
- Rate Limiting : aucune protection contre les abus (brute force, scraping, DDoS basique). À ajouter : middleware rate limiting par IP et par user authentifié.

---

## 5. Scaling

### EXISTANT

| Question | Réponse |
|----------|---------|
| Coût estimé par utilisateur | Non documenté |
| Rate limits APIs externes | Non documenté (Stream, Tally) |
| Besoin de sharding DB | Non (D1 suffit pour POC) |
| Cache en place | ❌ Non |

**APIs externes utilisées :**
- Cloudflare Stream (vidéos signées)
- Tally (webhooks quiz)
- Cloudflare Access (auth)

### CIBLE

- Bottlenecks identifiés
- Coûts estimés
- `SCALING_TODO.md` créé

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1408 | Pas de SCALING_TODO.md | Documenter bottlenecks | P3 |

---

## 6. CI/CD AI Powered

### EXISTANT

| Question | Réponse |
|----------|---------|
| Flux CI/CD défini | ❌ Non |
| Beta-testeurs identifiés | ❌ Non |
| Portail feedback existe | ❌ Non |
| Pruning régulier prévu | ❌ Non |

### CIBLE

- Flux CI/CD agentique documenté
- Beta-testeurs onboardés
- Portail feedback fonctionnel
- Schedule pruning défini

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1409 | Pas de CI/CD | GitHub Actions ou équivalent | P3 |
| GAP-1410 | Pas de beta feedback | Portail feedback beta testeurs | P3 |

---

## 7. Backup & Redondance DB

### EXISTANT

| Question | Réponse |
|----------|---------|
| Backups automatiques ? | ✅ D1 Time Travel (30 jours plan gratuit) |
| Export/dump possible ? | ✅ `wrangler d1 export` |
| Procédure restauration documentée ? | ❌ Non |
| Test de restauration effectué ? | ❌ Non |
| Backup externe (hors Cloudflare) ? | ❌ Non |

**Cloudflare D1 Time Travel :**
- Restauration point-in-time automatique
- 30 jours sur plan gratuit, plus sur paid
- Commande : `wrangler d1 time-travel restore lms-db --timestamp <ISO8601>`

### CIBLE

- Procédure de restauration documentée
- Test de restauration périodique
- Export hebdomadaire vers stockage externe (optionnel)

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1416 | Pas de procédure restauration | Documenter + tester restauration D1 | P1 |
| GAP-1417 | Pas de backup externe | Export périodique vers R2/GCS (optionnel) | P3 |

---

## 8. Rotation des Secrets

### EXISTANT

| Question | Réponse |
|----------|---------|
| Processus de rotation défini ? | ❌ Non |
| Fréquence de rotation ? | ❌ Non définie |
| Script de rotation ? | ❌ Non |
| Secrets avec expiration ? | ❌ Non |

**Secrets actuels (pas de rotation) :**
- `TALLY_WEBHOOK_SECRET`
- `TALLY_SIGNING_SECRET`
- `CLOUDFLARE_STREAM_SIGNING_KEY_ID`
- `CLOUDFLARE_STREAM_SIGNING_KEY_PEM`
- `TEST_SECRET` (nouveau)

### CIBLE

- Processus de rotation documenté
- Script `rotate_secret.py` pour rotation sans downtime
- Rotation annuelle minimum (ou après incident)

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1418 | Pas de processus rotation | Documenter processus rotation secrets | P2 |
| GAP-1419 | Pas de script rotation | Script rotation sans downtime | P3 |

---

## 9. Fragmentation organisationnelle

### EXISTANT

| Problème | Description |
|----------|-------------|
| Directives éclatées | `02.Directives/lms/` + `02.Directives/cloudflare/` sans lien explicite |
| Scripts éparpillés | `deploy_workers.py` dans cloudflare/ mais utilisé par LMS |
| Docs mal placées | Audit Phase 1 dans `04.Execution/lms/docs/` |
| Mapping manquant | `_lms_directive_script_map.md` existe mais pas maintenu |

### CIBLE

| Aspect | Cible |
|--------|-------|
| Directives | Une seule source par domaine (ou imports explicites) |
| Scripts | Scripts devops internes au projet LMS |
| Docs | Docs dans `docs/` à la racine du projet |
| Mapping | Relations explicites directive → script |

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1411 | Directives éclatées lms/ + cloudflare/ | Une seule source par domaine | P1 |
| GAP-1412 | Scripts LMS utilisent `04.Execution/cloudflare/` | Scripts devops internes au projet | P1 |
| GAP-1413 | Docs audit dans `04.Execution/lms/docs/` | Docs dans `docs/` à la racine | P1 |
| GAP-1414 | `_lms_directive_script_map.md` non maintenu | Relations explicites directive→script | P2 |

---

## GAPs Consolidés

### Backup & Data (P1)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1416 | Pas de procédure restauration DB | Phase 2 |

### Fragmentation organisationnelle (P1)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1411 | Directives éclatées lms/ + cloudflare/ | Phase 2 |
| GAP-1412 | Scripts LMS utilisent `04.Execution/cloudflare/` | Phase 2 |
| GAP-1413 | Docs audit dans `04.Execution/lms/docs/` | Phase 2 |

### Scripts de déploiement (P1-P2)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1401 | Scripts à la racine (pas dans scripts/devops/) | Phase 2 |
| GAP-1402 | Pas de verify_deploy (smoke tests) | Phase 2 |
| GAP-1403 | Pas de check_secrets | Phase 2 |
| GAP-1404 | Pas de check_security | Phase 2 |

### Environnements et sécurité (P2)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1405 | env.staging incomplet | Phase 2 |
| GAP-1406 | Pas de headers sécurité (CSP, HSTS) | Phase 2 |
| GAP-1414 | Mapping directive→script non maintenu | Phase 2 |
| GAP-1415 | Pas de rate limiting | Phase 2 |
| GAP-1418 | Pas de processus rotation secrets | Phase 2 |

### Scaling et CI/CD (P3)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1407 | deploy.sh interactif | Phase 3 |
| GAP-1408 | Pas de SCALING_TODO.md | Phase 3 |
| GAP-1409 | Pas de CI/CD | Phase 3 |
| GAP-1410 | Pas de beta feedback | Phase 3 |
| GAP-1417 | Pas de backup externe DB | Phase 3 |
| GAP-1419 | Pas de script rotation secrets | Phase 3 |

---

## Récap

| Sévérité | Count | IDs |
|----------|-------|-----|
| P1 | 5 | GAP-1401, GAP-1411, GAP-1412, GAP-1413, **GAP-1416** |
| P2 | 8 | GAP-1402, GAP-1403, GAP-1404, GAP-1405, GAP-1406, GAP-1414, GAP-1415, **GAP-1418** |
| P3 | 6 | GAP-1407, GAP-1408, GAP-1409, GAP-1410, **GAP-1417**, **GAP-1419** |
| **Total** | **19** | |

---

## Points positifs

- ✅ Workflow dev simplifié (`reset_db.py --dev`)
- ✅ Auth bien implémentée (Cloudflare Access + JWT)
- ✅ CORS configuré proprement (liste blanche)
- ✅ Rollback documenté et fonctionnel
- ✅ Secrets gérés via wrangler secret

## Points critiques

- ❌ **Fragmentation sévère** : directives/scripts/docs éparpillés entre domaines
- ❌ Arborescence non conforme (déjà identifié GAP-905)
- ❌ Staging non fonctionnel
- ❌ Pas de smoke tests automatisés

---

*Audit réalisé le 2024-12-28*

