# 1.17 - Audit Tests LMS

> Directive source : `02.Directives/app_factory/phase1/1.17_tests.md`
> Inputs : 1.03 (User Journey), 1.07 (Endpoints), 1.10 (Sequences)

---

## 1. Cahier de Recette

### EXISTANT

| Question | Réponse |
|----------|---------|
| Cahier de recette existe ? | ⚠️ Template dans 1.03, pas de fichier dédié |
| Scénarios documentés ? | ✅ 3 scénarios dans 1.03 (Happy Path, Resume, Retour arrière) |
| États DB attendus documentés ? | ❌ Non |

**Extrait 1.03_user_journey.md :**

```markdown
### Scénario 1 : Happy Path
| Step | Action                     | Résultat attendu              |
|------|----------------------------|-------------------------------|
| 1    | Accès app                  | Welcome screen                |
| 2    | Click cours dans sidebar   | Step 1 affiché                |
| 3    | Voir vidéo 100%            | Bouton Suivant actif          |
| 4    | Click Suivant              | Step 2 affiché                |
| 5    | Quiz passé                 | XP ajouté, Suivant actif      |
| 6    | Compléter tous steps       | End screen, badge             |
| 7    | Click Continuer            | Retour Welcome                |
```

### CIBLE

```markdown
# Cahier de Recette - LMS

## Pré-requis
- [ ] reset_db.py --dev exécuté
- [ ] Utilisateur test connecté

## Scénario 1 : Happy Path Complet
| Step | Action | Résultat attendu | État DB attendu |
|------|--------|------------------|-----------------|
| 1 | Accès app | Welcome screen | crm_contact créé |
| 2 | Click cours | Step 1 affiché | - |
| 3 | Vidéo 90%+ | Quiz débloqué | lms_event VIDEO_PING, v_user_progress.video_completed=1 |
| 4 | Quiz passé | XP affiché | lms_event QUIZ_SUBMIT, gamification_award |
| 5 | Tous steps | End screen + badge | course_completed=1, badge awarded |
```

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1701 | Template dans 1.03 | Fichier `docs/cahier_recette.md` dédié | P2 |
| GAP-1702 | Pas d'états DB | États DB attendus documentés | P2 |

---

## 2. Scénarios par Priorité

### EXISTANT

| Priorité | Scénarios listés ? |
|----------|-------------------|
| P1 (bloquant) | ✅ Happy Path (1.03) |
| P2 (important) | ⚠️ Resume (1.03), pas de edge cases quiz/vidéo |
| P3 (nice-to-have) | ❌ |

**Scénarios documentés dans 1.03 :**
1. Happy Path (complet cours)
2. Resume (quitter/revenir)
3. Retour arrière (bloqué)

### CIBLE

| Priorité | Scénarios |
|----------|-----------|
| **P1** | Happy path complet, Auth (JWT valid), Resume |
| **P2** | Quiz fail, Vidéo < 90%, Multi-cours, Refresh page |
| **P3** | Concurrence (2 onglets), Timeout, Offline |

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1703 | 3 scénarios | Liste complète P1/P2/P3 | P2 |
| GAP-1704 | Pas de scénarios négatifs | Quiz fail, Vidéo incomplète | P2 |

---

## 3. Code Non Utilisé (Pruning)

### EXISTANT

| Type | Candidats identifiés ? | Détail |
|------|------------------------|--------|
| Endpoints non appelés | ⚠️ Legacy endpoints | `/api/video-event`, `/api/quiz-submission`, `/api/learner` |
| Handlers non utilisés | ❌ | À vérifier |
| Composants non rendus | ❌ | À vérifier |
| Tables DB vides | ❌ | À vérifier |

**Endpoints Legacy identifiés (1.07) :**

```javascript
// worker_api/index.js - redirects legacy
if (path === '/api/video-event') → /api/events
if (path === '/api/quiz-submission') → handleQuizSubmission
if (path === '/api/learner') → /api/student
if (path === '/api/soms') → /api/courses
if (path === '/api/progress') → /api/signals
```

**Fichiers suspects (à auditer) :**

| Fichier | Usage | Décision |
|---------|-------|----------|
| `tally_webhook.py` | Script CLI legacy | À supprimer ? |
| `parse_som.py` | Parsing SOM markdown | À supprimer ? |
| `player_embed.js` (racine) | Dupliqué avec frontend/ | À supprimer |
| `sync_tally_quiz.py` | Sync Tally | À vérifier usage |

### CIBLE

- Liste des candidats au pruning ✅
- Décision : supprimer ou documenter usage
- Pas de dead code en production

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1705 | Endpoints legacy maintenus | Supprimer après migration tests | P3 |
| GAP-1706 | Scripts Python à la racine | Auditer et nettoyer | P3 |
| GAP-1707 | player_embed.js dupliqué | Supprimer à la racine | P3 |

---

## 4. Mode Dry-Run

### EXISTANT

| Élément | Dry-run possible ? | Comment ? |
|---------|-------------------|-----------|
| Jobs async | ❌ | N/A (pas de jobs) |
| Webhooks | ❌ | Tally webhook pas de mode test |
| Events | ❌ | Pas de `?dry_run=true` |
| Reset DB | ✅ | `reset_db.py --verify` (lecture seule) |

### CIBLE

- Mode dry-run sur tous les éléments avec side-effects
- Flag `?dry_run=true` sur les endpoints concernés

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1708 | Pas de dry-run sur /events | `?dry_run=true` retourne résultat sans INSERT | P3 |
| GAP-1709 | Pas de dry-run sur /quiz | `?dry_run=true` | P3 |

---

## 5. Outils de Test

### EXISTANT

| Outil | Utilisé ? | Pour quoi ? |
|-------|-----------|-------------|
| Requestly | ❌ | Non configuré |
| Postman | ❌ | Pas de collection |
| Tests unitaires | ⚠️ | `tests/test_api.py` existe mais **OBSOLÈTE** |

**Problème test_api.py :**

```python
# tests/test_api.py - Endpoints OBSOLÈTES
def test_video_play_event():
    response = requests.post(f"{API_BASE}/api/video-event", ...)  # ❌ Legacy
    
def test_quiz_submission_pass():
    response = requests.post(f"{API_BASE}/api/quiz-submission", ...)  # ❌ Legacy
```

Les tests utilisent les **anciens endpoints** (`video-event`, `quiz-submission`) au lieu des nouveaux (`/events`, `/quiz`).

### CIBLE

- Requestly configuré pour session recording
- Collection Postman avec endpoints actuels
- Tests E2E mis à jour

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1710 | tests/test_api.py obsolète | Réécrire avec nouveaux endpoints | P2 |
| GAP-1711 | Pas de collection Postman | Générer depuis 1.07 | P2 |
| GAP-1712 | Pas de Requestly | Configurer session recording | P3 |

---

## 6. Données de Seed

### EXISTANT

| Table | Données seed ? | Reset possible ? | Source |
|-------|---------------|-----------------|--------|
| lms_course | ✅ | ✅ | `03.Orchestration/lms/courses/*.json` |
| lms_class | ✅ | ✅ | Inclus dans courses JSON |
| gamification_badge | ✅ | ✅ | `schema.sql` (INSERT) |
| crm_contact | ❌ | ✅ (vidé) | Créé à l'auth |
| lms_event | ❌ | ✅ (vidé) | Événements runtime |
| v_user_progress | ❌ | ✅ (vidé) | Projections |

**Script de reset existant :**

```bash
# reset_db.py --dev
# - Vide les tables de données utilisateur
# - Re-seed les cours depuis 03.Orchestration/lms/courses/
# - Déploie Worker + Frontend
```

### CIBLE

- Données seed pour chaque table importante ✅
- Script de reset avant chaque test ✅
- Environnement 100% reproductible ✅

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| *(Aucun)* | reset_db.py fonctionnel | - | - |

---

## 7. Récapitulatif des GAPs Tests

### Par sévérité

| Sévérité | Count | IDs |
|----------|-------|-----|
| **P1** | 0 | - |
| **P2** | 6 | GAP-1701, GAP-1702, GAP-1703, GAP-1704, GAP-1710, GAP-1711 |
| **P3** | 6 | GAP-1705, GAP-1706, GAP-1707, GAP-1708, GAP-1709, GAP-1712 |

### Total : 12 GAPs (0 P1, 6 P2, 6 P3)

### Vue consolidée

| ID | GAP | Existant | Cible | Sévérité |
|----|-----|----------|-------|----------|
| GAP-1701 | Cahier de recette | Template dans 1.03 | Fichier dédié | P2 |
| GAP-1702 | États DB | Non documentés | États attendus par step | P2 |
| GAP-1703 | Scénarios | 3 scénarios | Liste P1/P2/P3 complète | P2 |
| GAP-1704 | Scénarios négatifs | Aucun | Quiz fail, vidéo incomplète | P2 |
| GAP-1705 | Endpoints legacy | Maintenus (compat) | Supprimer après migration | P3 |
| GAP-1706 | Scripts racine | Python en vrac | Auditer et nettoyer | P3 |
| GAP-1707 | player_embed.js | Dupliqué | Supprimer à la racine | P3 |
| GAP-1708 | Dry-run events | Non | `?dry_run=true` | P3 |
| GAP-1709 | Dry-run quiz | Non | `?dry_run=true` | P3 |
| GAP-1710 | **test_api.py** | **Endpoints obsolètes** | Réécrire avec /events, /quiz | **P2** |
| GAP-1711 | Collection Postman | Aucune | Générer depuis 1.07 | P2 |
| GAP-1712 | Session recording | Non configuré | Requestly | P3 |

---

## 8. Candidats Pruning

### À supprimer

| Fichier | Raison | Action |
|---------|--------|--------|
| `player_embed.js` (racine) | Dupliqué dans `frontend/` | Supprimer |
| Endpoints legacy dans index.js | Après migration tests | Garder pour now |

### À auditer

| Fichier | Question |
|---------|----------|
| `tally_webhook.py` | Utilisé ? Par quoi ? |
| `parse_som.py` | Encore utile ? |
| `sync_tally_quiz.py` | Fréquence usage ? |

### Tests obsolètes

| Fichier | Problème | Action |
|---------|----------|--------|
| `tests/test_api.py` | Utilise `/api/video-event` au lieu de `/api/events` | Réécrire entièrement |

---

## 9. Bilan

### Points positifs

1. ✅ **reset_db.py** : Script de reset fonctionnel avec seed
2. ✅ **Scénarios documentés** : 3 scénarios dans 1.03
3. ✅ **Endpoints documentés** : 1.07 exhaustif

### Points négatifs

1. ❌ **test_api.py OBSOLÈTE** : Utilise les anciens endpoints
2. ❌ **Pas de cahier de recette dédié** : Juste un template
3. ❌ **Pas de collection Postman** : Tests manuels impossibles
4. ❌ **Pas de scénarios négatifs** : Que happy path

### Prochaines étapes (Phase 5)

1. Réécrire `test_api.py` avec nouveaux endpoints
2. Créer `docs/cahier_recette.md` depuis template 1.03
3. Générer collection Postman depuis 1.07
4. Nettoyer les fichiers dupliqués/obsolètes

---

*Créé le : 2024-12-28*

