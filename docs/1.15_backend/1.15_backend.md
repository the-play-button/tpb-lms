# 1.15 - Audit Backend

> Audit de l'architecture backend du POC LMS : handlers, logique métier, call-chains.

---

## 1. Complétude des specs Phase 1

### EXISTANT

| Spec | Status | Notes |
|------|--------|-------|
| ERD complet (1.05) | ✅ | Tables Unified.to + extensions gamification + event-sourcing |
| Endpoints listés avec I/O (1.07) | ✅ | 15 endpoints documentés avec inputs/outputs/side-effects |
| Flux validé flèche par flèche (1.08) | ✅ | Diagramme mermaid existant vs cible |
| Séquences documentées (1.10) | ✅ | 4 séquences existantes, 4 séquences cibles |

### CIBLE

- Toutes les specs ✅
- **Si quelque chose manque → retour aux étapes 1.05-1.10**

### GAP

**Aucun GAP** - Specs Phase 1 complètes, pas de retour en arrière nécessaire.

---

## 2. Séparation logique front/back

### EXISTANT

| Question | Réponse |
|----------|---------|
| Calculs côté front ? | ⚠️ Minimal (coverage_pct dans renderer.js) |
| Validations côté front seulement ? | ❌ Non - validation côté back aussi |
| Endpoints `front_*` existent ? | ❌ Non |
| Liste des endpoints front : | Aucun |

**Calculs backend (OK)** :
- Progression via `v_user_progress` (materialized view)
- XP/badges via `helpers/xp.js`
- Signals via `projections/engine.js`
- Step completion dans `handlers/signals.js`

**Calculs frontend (minimal)** :
- `coverage_pct` dans `course/renderer.js` (pourrait être backend)

### CIBLE

- **Règle absolue** : le front ne fait qu'afficher et envoyer des events
- Tous les calculs dans le backend
- Endpoints `front_*` pour les vues agrégées :
  ```
  GET  /api/front_dashboard
  GET  /api/front_admin
  GET  /api/front_mastery/:id
  ```

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-705 | Pas d'endpoint front_dashboard | Endpoint user dashboard | P1 |
| GAP-706 | Pas d'endpoint front_admin | Endpoint admin dashboard | P1 |
| GAP-707 | Pas d'endpoint front_mastery | Endpoint mastery % | P1 |

*Note : GAPs déjà identifiés en 1.07*

---

## 3. Call-chains

### EXISTANT

| Handler | Appelle | Side-effects | Lignes |
|---------|---------|--------------|--------|
| `events.js` | `projections/engine.js`, `getProgress()` | INSERT lms_event, UPSERT v_user_progress | 211 |
| `quiz.js` | `helpers/xp.js`, `projections/engine.js` | INSERT lms_event, crm_event | 240 |
| `courses.js` | DB direct | SELECT only | 157 |
| `signals.js` | DB direct | SELECT + DELETE (reset) | 180 |
| `leaderboard.js` | DB direct | SELECT only | 147 |
| `badges.js` | DB direct | SELECT only | 55 |
| `learner.js` | DB direct | SELECT only | 87 |
| `auth.js` | DB direct + verifyAccessJWT | SELECT/INSERT crm_contact | 102 |

**Call-chain la plus profonde** :

```
handleEvent()
  └── applyProjections()
        └── [VIDEO_PROGRESS_PROJECTION, QUIZ_RESULT_PROJECTION]
              └── upsertState()
```

= **3 niveaux** de profondeur, acceptable.

**Red flags** :
- [x] Handler qui appelle 10+ autres handlers : ❌ Non détecté
- [x] Boucles de dépendances : ❌ Non détecté
- [x] Logique dupliquée : ⚠️ OUI - `quiz.js` duplique INSERT lms_event de `events.js`

### CIBLE

- Call-chains documentées pour chaque handler complexe
- Max 3-4 niveaux de profondeur
- Pas de logique dupliquée

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1501 | `quiz.js` duplique INSERT lms_event | Factoriser dans helper commun | P2 |

---

## 4. Documentation API

### EXISTANT

| Question | Réponse |
|----------|---------|
| OpenAPI/Swagger existe ? | ❌ Non |
| Collection Postman existe ? | ❌ Non |
| Exemples de requêtes documentés ? | ⚠️ Partiel (dans tests/test_api.py) |

**Tests existants** (`tests/test_api.py`, 315 lignes) :
- Health check ✅
- Video events (play, progress, completion) ✅
- Quiz submission (pass, fail, perfect) ✅
- Learner progress ✅
- Leaderboard ✅
- Tally webhook ✅

### CIBLE

- `docs/openapi.yaml` généré
- Collection Postman importable
- Tous les endpoints testables sans frontend

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-1502 | Pas de OpenAPI/Swagger | Générer openapi.yaml | P2 |
| GAP-1503 | Pas de collection Postman | Créer collection | P3 |

---

## 5. Structure backend

### EXISTANT

```
worker_api/                    (1896 lignes total)
├── auth.js                    (184 lignes) - JWT verification
├── config.js                  (20 lignes)  - Configuration
├── cors.js                    (56 lignes)  - CORS headers
├── index.js                   (226 lignes) - Point d'entrée + routing
├── handlers/                  (1179 lignes total)
│   ├── auth.js                (102) - Session endpoint
│   ├── badges.js              (55)  - List badges
│   ├── courses.js             (157) - List/Get courses
│   ├── events.js              (211) - Event ingestion
│   ├── leaderboard.js         (147) - Leaderboard
│   ├── learner.js             (87)  - Learner profile
│   ├── quiz.js                (240) - Quiz + Tally webhook
│   └── signals.js             (180) - Progress signals
├── helpers/
│   └── xp.js                  (?)   - XP/badge logic
└── projections/               (231 lignes total)
    ├── engine.js              (131) - Projection engine
    └── rules/
        ├── quiz_result.js     (49)  - Quiz projection
        └── video_progress.js  (51)  - Video projection
```

| Question | Réponse |
|----------|---------|
| Fichiers < 500 lignes ? | ✅ Tous < 250 lignes |
| Séparation handlers/helpers claire ? | ✅ |
| Point d'entrée unique ? | ✅ index.js |
| Middleware séparé ? | ⚠️ Non - auth dans auth.js mais pas de dossier middleware/ |

### CIBLE

```
backend/                       (renommé de worker_api/)
├── handlers/                  ✅ OK
├── helpers/                   ✅ OK
├── projections/               ✅ OK
├── middleware/                ❌ MANQUANT (guard, rbac)
│   ├── guard.js               → Pattern Intent+Guard
│   └── rbac.js                → Role-Based Access Control
├── index.js                   ✅ OK
└── config.js                  ✅ OK
```

### GAP

| ID | Existant | Cible | Sévérité |
|----|----------|-------|----------|
| GAP-901 | Dossier s'appelle worker_api/ | Renommer en backend/ | P1 |
| GAP-1504 | Pas de dossier middleware/ | Créer avec guard.js et rbac.js | P2 |

---

## GAPs Consolidés

### Séparation front/back (existants - confirmés)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-705 | Endpoint front_dashboard manquant | Phase 3 |
| GAP-706 | Endpoint front_admin manquant | Phase 3 |
| GAP-707 | Endpoint front_mastery manquant | Phase 3 |

### Call-chains (nouveau)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1501 | quiz.js duplique INSERT lms_event de events.js | Phase 3 |

### Documentation API (nouveaux)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-1502 | Pas de OpenAPI/Swagger | Phase 3 |
| GAP-1503 | Pas de collection Postman | Phase 4 |

### Structure backend (existant + nouveau)

| ID | Description | Phase cible |
|----|-------------|-------------|
| GAP-901 | Renommer worker_api/ → backend/ | Phase 2 |
| GAP-1504 | Dossier middleware/ manquant | Phase 3 |

---

## Récap

| Sévérité | Count | IDs |
|----------|-------|-----|
| P1 | 4 | GAP-705, GAP-706, GAP-707, GAP-901 |
| P2 | 3 | GAP-1501, GAP-1502, GAP-1504 |
| P3 | 1 | GAP-1503 |
| **Total nouveaux** | **4** | GAP-1501→1504 |

---

## Points positifs

- ✅ Architecture event-sourcing propre (events → projections → signals)
- ✅ Tous les fichiers < 250 lignes (bien structuré)
- ✅ Séparation handlers/helpers/projections claire
- ✅ Pas de calculs complexes côté front
- ✅ Tests API existants (test_api.py)
- ✅ Validation côté back (validateEventPayload)
- ✅ Call-chains peu profondes (max 3 niveaux)

## Points critiques

- ❌ Pas d'endpoints `front_*` pour dashboards (GAP-705/706/707)
- ❌ Pas de documentation API formelle (OpenAPI)
- ❌ Pas de dossier middleware/ (guard, rbac)
- ⚠️ Logique dupliquée entre quiz.js et events.js

---

*Audit réalisé le 2024-12-28*

