# Phase 6 - Developer Onboarding Flow

## Principe ZERO-SECRET

**AUCUN secret n'est donné par l'admin.** Le dev s'authentifie via SSO et vault-api lui génère ses credentials personnels.

Cloudflare est l'**infrastructure** (sous-jacente), vault-api est la **SSOT** (source de vérité pour l'IAM).

## Flow complet

```
Admin                          vault-api                      Cloudflare Access
  │                               │                                │
  │ POST /iam/users               │                                │
  │ {email: "dev@tpb.ai"}         │                                │
  ├──────────────────────────────►│                                │
  │                               │ cfAccess.grantUserAccess()     │
  │                               ├───────────────────────────────►│
  │                               │              policy created     │
  │                               │◄───────────────────────────────┤
  │      {user_id, cf_access: ok} │                                │
  │◄──────────────────────────────┤                                │
  │                               │                                │
  │ "Clone le repo et go"         │                                │
  │ (PAS DE SECRET DONNÉ!)        │                                │
  ├─────────────────────────────► Dev                              │
                                  │                                │
                                  │ Browser: vault-api.workers.dev │
                                  ├───────────────────────────────►│
                                  │        SSO login (email)        │
                                  │        (pas de secret !)        │
                                  │◄───────────────────────────────┤
                                  │                                │
                                  │ POST /iam/service-tokens       │
                                  ├──────────────────────────────► vault-api
                                  │                                │
                                  │ cfAccess.createServiceToken()  │
                                  │ cfAccess.addPolicy()           │
                                  ├───────────────────────────────►│
                                  │                                │
                                  │ {VAULT_CLIENT_ID, SECRET}      │
                                  │◄────────────────────────────────
                                  │
                                  │ .devcontainer/.env (copier)
                                  └─────────────────────────────────
```

## Variables d'environnement

**Naming convention** : `VAULT_*` (pas `CLOUDFLARE_*`)

```bash
# .devcontainer/.env - généré par vault-api après auth SSO
VAULT_CLIENT_ID=xxx.access
VAULT_CLIENT_SECRET=xxx
```

Le vault_client.py supporte les deux noms (rétrocompatibilité).

## Handler iam.js (implémenté)

Le handler `/iam/service-tokens` :
1. Crée le token via CF API
2. Ajoute le token aux policies de vault-api (atomique)
3. Retourne `env_file` avec `VAULT_CLIENT_*`

```javascript
return success({
  token: { id, name, client_id, client_secret, expires_at },
  env_file: `# TPB Dev Container Credentials
# Generated by vault-api on ${timestamp}
VAULT_CLIENT_ID=${clientId}
VAULT_CLIENT_SECRET=${clientSecret}`,
  note: 'Copy env_file content to .devcontainer/.env'
});
```

## Documentation dev (.devcontainer/README.md)

```markdown
# Dev Container Setup

## Flux ZERO-SECRET

Aucun secret n'est fourni par l'admin. Tu t'authentifies via SSO.

## First Time Setup

1. **Demander l'accès** (admin fait):
   ```bash
   # vault-api UI ou CLI
   POST /iam/users {email: "ton.email@theplaybutton.ai"}
   ```

2. **Se connecter au vault**:
   - Aller sur https://tpb-vault-infra.matthieu-marielouise.workers.dev
   - S'authentifier via Cloudflare Access (SSO email)
   - Aucun mot de passe, juste ton email

3. **Générer ton token**:
   - Aller sur /iam/service-tokens
   - Cliquer "Generate" (ou POST via curl)
   - vault-api génère ET t'autorise automatiquement

4. **Copier dans .devcontainer/.env**:
   ```
   VAULT_CLIENT_ID=<ton-client-id>
   VAULT_CLIENT_SECRET=<ton-secret>
   ```

5. **Rebuild le Container**:
   Cmd+Shift+P → "Dev Containers: Rebuild Container"

## Token Rotation

Ton token expire après 1 an. Pour renouveler:
1. Révoquer l'ancien dans vault-api UI
2. Générer un nouveau
3. Mettre à jour .devcontainer/.env
4. Rebuild le container
```

## Script CLI admin (optionnel)

```python
#!/usr/bin/env python3
"""Onboard a new developer"""
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent.parent))
from vault_client import VaultClient
import httpx

def main():
    if len(sys.argv) < 2:
        print("Usage: python onboard_dev.py <email> [name]")
        sys.exit(1)
    
    email = sys.argv[1]
    name = sys.argv[2] if len(sys.argv) > 2 else email.split('@')[0]
    
    client = VaultClient.from_env()
    
    resp = httpx.post(
        f"{client.base_url}/iam/users",
        headers={**client.headers, 'Content-Type': 'application/json'},
        json={"email": email, "display_name": name}
    )
    
    if resp.status_code == 201:
        print(f"✅ User {email} created + CF Access granted")
        print(f"   Ils peuvent maintenant:")
        print(f"   1. Cloner le repo")
        print(f"   2. Se connecter à {client.base_url}")
        print(f"   3. Générer leur token")
    elif resp.status_code == 409:
        print(f"⚠️  User {email} already exists")
    else:
        print(f"❌ Error: {resp.text}")

if __name__ == "__main__":
    main()
```

## Checklist déploiement

- [x] Schema D1 mis à jour avec IAM tables
- [x] `cfAccess.js` créé (contrôle CF Access)
- [x] Handlers users/groups/roles créés
- [x] Handler `/iam/service-tokens` avec policy auto
- [x] Routes ajoutées dans index.js
- [x] Handler `/iam/can` pour CASL
- [x] Variables `VAULT_CLIENT_*` (pas CLOUDFLARE_*)
- [x] Auth middleware: POST /iam/can whitelisted pour service tokens
- [ ] `CLOUDFLARE_API_TOKEN_IAM` configuré en secret
- [x] Documentation mise à jour
